name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Only deploy if server is configured
    if: ${{ secrets.SERVER_HOST != '' }}
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/stats-lab-manager
            git pull origin main
            docker compose -f docker-compose.ec2.yml up -d --build --remove-orphans
            # Run migrations
            sleep 5
            for f in database/migrations/*.sql; do
              docker exec -i statslab-db psql -U statslab -d statslab < "$f" 2>/dev/null || true
            done
            docker system prune -f
            echo "Deployment complete!"
