name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          script: |
            sudo swapon /swapfile 2>/dev/null || true
            cd /opt/stats-lab-manager
            git fetch origin main
            git reset --hard origin/main
            # Sync SSL nginx config from repo to host (if SSL is set up)
            if [ -f /etc/letsencrypt/live/utahvalleyresearchlab.com/fullchain.pem ]; then
              sudo cp deploy/ssl.conf /etc/nginx/conf.d/ssl.conf
            fi
            docker compose -f docker-compose.ec2.yml down --timeout 30 || true
            docker system prune -af --volumes 2>/dev/null || docker system prune -f
            docker compose -f docker-compose.ec2.yml up -d --build --remove-orphans --wait --wait-timeout 120
            for f in database/migrations/*.sql; do
              docker exec -i statslab-db psql -U statslab -d statslab < "$f" || true
            done
            docker system prune -f
            echo "=== Backend container status ==="
            docker inspect statslab-backend --format='{{.State.Status}} (exit: {{.State.ExitCode}}) health: {{.State.Health.Status}}' || true
            echo "=== Nginx container status ==="
            docker inspect statslab-nginx --format='{{.State.Status}} (exit: {{.State.ExitCode}})' || true
            echo "=== Nginx logs (last 20 lines) ==="
            docker logs statslab-nginx --tail 20 2>&1 || true
            echo "=== Backend logs (last 50 lines) ==="
            docker logs statslab-backend --tail 50 2>&1 || true
            echo "=== Deployment complete! ==="
            echo "=== Health check ==="
            curl -sf --insecure https://localhost/api/health 2>/dev/null || curl -sf http://localhost/api/health || (echo "Health check FAILED!" && exit 1)
            echo "Health check passed!"
